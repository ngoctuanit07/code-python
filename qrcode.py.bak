import tkinter as tk
from tkinter import ttk
import mysql.connector
import qrcode
from reportlab.lib.pagesizes import letter
from reportlab.pdfgen import canvas
from reportlab.lib.units import mm
from datetime import datetime

# Hàm tạo kết nối đến MySQL
def mysql_connection():
    return mysql.connector.connect(
        host="192.168.17.17",
        user="root",
        passwd="your_password",
        database="your_database"
    )

# Hàm truy vấn dữ liệu từ MySQL
def fetch_data(qrcode_from, qrcode_to):
    conn = mysql_connection()
    cursor = conn.cursor()
    if qrcode_to and qrcode_from:  # Nếu người dùng nhập cả Qrcode From và Qrcode To
        query = (
            "SELECT CONCAT(ID1, '-', Code) "
            "FROM receiptline "
            "WHERE ID1 >= %s AND ID1 <= %s AND CreatedDate >= %s AND IsDelete=0;"
        )
        cursor.execute(query, (qrcode_from, qrcode_to, f"{datetime.now().year}-01-01"))
    elif qrcode_from:  # Nếu người dùng chỉ nhập Qrcode From
        query = (
            "SELECT CONCAT(ID1, '-', Code) "
            "FROM receiptline "
            "WHERE ID1 >= %s AND CreatedDate >= %s AND IsDelete=0;"
        )
        cursor.execute(query, (qrcode_from, f"{datetime.now().year}-01-01"))
    else:  # Xử lý trường hợp không nhập gì hoặc chỉ nhập Qrcode To (tùy bạn thêm vào)
        return []
        
    data = cursor.fetchall()
    cursor.close()
    conn.close()
    return data

# Hàm tạo và lưu QR Code vào PDF
def generate_pdf(data):
    c = canvas.Canvas("qrcodes.pdf", pagesize=letter)
    width, height = letter
    x_offset, y_offset = 30 * mm, height - 100 * mm  # Khởi tạo vị trí bắt đầu
    for index, (code,) in enumerate(data):
        qr = qrcode.QRCode(version=1, box_size=10, border=5)
        qr.add_data(code)
        qr.make(fit=True)
        img = qr.make_image(fill='black', back_color='white')
        img_path = f"temp_{index}.png"
        img.save(img_path)

        if index % 20 == 0 and index != 0:  # Mới mỗi trang sau 20 QR Codes
            c.showPage()
            x_offset, y_offset = 30 * mm, height - 100 * mm
        elif index % 4 == 0 and index != 0:  # Reset vị trí x, giảm y sau mỗi hàng
            x_offset = 30 * mm
            y_offset -= 100 * mm
        
        c.drawImage(img_path, x_offset, y_offset, width=300, height=100)
        c.drawString(x_offset, y_offset - 10, code)  # Thêm label dưới QR Code
        x_offset += 80 * mm  # Tăng vị trí x cho QR Code tiếp theo

    c.save()

# GUI
def on_generate_button_clicked():
    qrcode_from = from_entry.get()
    qrcode_to = to_entry.get()
    data = fetch_data(qrcode_from, qrcode_to)
    if data:
        generate_pdf(data)
    else:
        print("No data to generate QR codes. Please check your input.")

root = tk.Tk()
root.title("QR Code Generator")

tk.Label(root, text="QRCode From:").pack()
from_entry = tk.Entry(root)
from_entry.pack()

tk.Label(root, text="QRCode To:").pack()
to_entry = tk.Entry(root)
to_entry.pack()

generate_button = ttk.Button(root, text="Generate QR Codes", command=on_generate_button_clicked)
generate_button.pack()

root.mainloop()